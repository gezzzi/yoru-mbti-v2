// å¤œã®ç›¸æ€§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

// ã‚¿ã‚°ææ¡ˆãƒ‡ãƒ¼ã‚¿
export const getTagRecommendations = (combinedTags: Set<string>) => {
  const recommendations: { tag: string; text: string }[] = [];
  
  // å„ã‚¿ã‚°ã«å¯¾ã™ã‚‹ææ¡ˆã‚’è¿½åŠ ï¼ˆæƒ…æ™¯è±Šã‹ãªç‰ˆï¼‰
  const tagTexts: { [key: string]: string } = {
    'ğŸ’¬ è¨€èªãƒ—ãƒ¬ã‚¤æ´¾': 'è€³å…ƒã§å›ã‹ã‚Œã‚‹ç”˜ã„è¨€è‘‰ãŒã€å…¨èº«ã‚’éœ‡ã‚ã›ã‚‹ã€‚æ¥ãšã‹ã—ã„è¨€è‘‰ã‚‚ã€äºŒäººã ã‘ã®ç§˜å¯†ã®å‘ªæ–‡ã«ã€‚',
    'ğŸ—£ ä¸‹ãƒã‚¿OK': 'æ¬²æœ›ã‚’ç´ ç›´ã«å£ã«ã—ã€ãŠäº’ã„ã®æ¸‡æœ›ã‚’ç¢ºã‹ã‚åˆã†é–‹æ”¾çš„ãªé–¢ä¿‚ã€‚',
    'ğŸ•¯ ãƒ­ãƒãƒ³é‡è¦–': 'ã‚­ãƒ£ãƒ³ãƒ‰ãƒ«ã®ç¯ã‚ŠãŒäºŒäººã®å½±ã‚’å£ã«æºã‚‰ã—ã€ã‚¢ãƒ­ãƒã®é¦™ã‚ŠãŒäº”æ„Ÿã‚’åˆºæ¿€ã™ã‚‹ã€‚',
    'ğŸª é¡ãƒ—ãƒ¬ã‚¤å¥½ã': 'é¡ã«æ˜ ã‚‹äºŒäººã®å§¿ã‚’è¦‹ã¤ã‚ãªãŒã‚‰ã€èˆˆå¥®ãŒå€å¢—ã—ã¦ã„ãèƒŒå¾³çš„ãªå¿«æ„Ÿã€‚',
    'ğŸ® ã‚²ãƒ¼ãƒ æ´¾': 'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ãŸã‚Šã€ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ãŸã‚Šã€‚éŠã³å¿ƒæº€è¼‰ã®ã‚¹ãƒªãƒªãƒ³ã‚°ãªæ™‚é–“ã€‚',
    'ğŸ’‹ ã‚­ã‚¹é­”': 'æ¯ãŒã§ããªã„ã»ã©æ¿ƒåšãªã‚­ã‚¹ã€‚å”‡ã¨å”‡ãŒè§¦ã‚Œã‚‹ãŸã³ã«ã€é›»æµãŒèµ°ã‚‹ã‚ˆã†ãªæ„Ÿè¦šã€‚',
    'ğŸ§¥ ã‚³ã‚¹ãƒ—ãƒ¬æ´¾': 'åˆ¶æœã‚„ã‚³ã‚¹ãƒãƒ¥ãƒ¼ãƒ ãŒç”Ÿã¿å‡ºã™éæ—¥å¸¸ã®èˆˆå¥®ã€‚ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãŒç¾å®Ÿã«ã€‚',
    'âš¡ï¸ ã‚¹ãƒ”ãƒ¼ãƒ‰å‹è² æ´¾': 'ç¬é–“çš„ã«ç‡ƒãˆä¸ŠãŒã‚‹ç‚ã®ã‚ˆã†ãªæƒ…ç†±ã€‚çŸ­ãã¨ã‚‚æ¿ƒå¯†ãªæ™‚é–“ã€‚',
    'ğŸƒâ€â™‚ï¸ è¡å‹•ãƒˆãƒªã‚¬ãƒ¼å‹': 'ã‚­ãƒƒãƒãƒ³ã§ã€ã‚½ãƒ•ã‚¡ã§ã€ç„é–¢ã§ã€‚æ—¥å¸¸ã®ä¸­ã«æ½œã‚€ç‰¹åˆ¥ãªç¬é–“ã‚’é€ƒã•ãªã„ã€‚',
    'ğŸ”¥ æ¬²æœ›ã®ç‚': 'æŠ‘ãˆãã‚Œãªã„æƒ…ç†±ãŒçˆ†ç™ºã€‚ãŠäº’ã„ã®é™ç•Œã¾ã§æ±‚ã‚åˆã†æ¿€ã—ã„å¤œã€‚',
    'ğŸ”„ ãƒªãƒ”ãƒ¼ãƒˆæ±‚ã‚æ´¾': 'ä¸€åº¦ã§ã¯çµ‚ã‚ã‚‰ãªã„ã€‚ä½•åº¦ã‚‚æ³¢ã®ã‚ˆã†ã«æŠ¼ã—å¯„ã›ã‚‹å¿«æ„Ÿã®æ³¢ã€‚',
    'ğŸ› ã‚¢ãƒ•ã‚¿ãƒ¼ã‚±ã‚¢å¿…é ˆ': 'æ¿€ã—ã„åµã®å¾Œã®å„ªã—ã„å‡ªã€‚æŠ±ãã—ã‚åˆã„ãªãŒã‚‰æ„›ã‚’ç¢ºã‹ã‚åˆã†å¤§åˆ‡ãªæ™‚é–“ã€‚',
    'ğŸ§¼ ã‚±ã‚¢ï¼†è¡›ç”Ÿé‡è¦–': 'æ¸…æ½”ãªã‚·ãƒ¼ãƒ„ã€å„ªã—ã„æ‰‹ã¤ãã€‚ãŠäº’ã„ã‚’æ€ã„ã‚„ã‚‹ä¸å¯§ãªæ™‚é–“ã€‚',
    'ğŸ›¡ å®‰å…¨ç¬¬ä¸€æ´¾': 'å®‰å¿ƒã§ãã‚‹ç’°å¢ƒã§ã€å¿ƒã‹ã‚‰ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦æ¥½ã—ã‚ã‚‹ã€‚',
    'ğŸšª NGæ˜ç¢º': 'ã€Œã“ã‚Œã¯å¤§ä¸ˆå¤«ã€ã€Œã“ã‚Œã¯NGã€ã€‚æ˜ç¢ºãªå¢ƒç•Œç·šãŒå®‰å¿ƒæ„Ÿã‚’ç”Ÿã‚€ã€‚',
    'â˜€ï¸ æœå‹ã‚¨ãƒ­ã‚¹': 'æœæ—¥ãŒå·®ã—è¾¼ã‚€ãƒ™ãƒƒãƒ‰ã§ã€æ–°ã—ã„ä¸€æ—¥ã‚’ç‰¹åˆ¥ã«å§‹ã‚ã‚‹å¹¸ã›ã€‚',
    'â›ï¸ é–‹æ‹“æ´¾': 'æœªçŸ¥ã®é ˜åŸŸã¸ã®æ¢æ¤œã€‚ãŠäº’ã„ã®æ–°ã—ã„ä¸€é¢ã‚’ç™ºè¦‹ã™ã‚‹å†’é™ºã€‚',
    'ğŸ­ ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤å¥½ã': 'å…ˆç”Ÿã¨ç”Ÿå¾’ã€ä¸Šå¸ã¨éƒ¨ä¸‹ã€‚äºŒäººã ã‘ã®ç‰©èªã«æ²¡å…¥ã™ã‚‹æ™‚é–“ã€‚',
    'ğŸ“± ãƒ‡ã‚¸ã‚¿ãƒ«å‰æˆ¯æ´¾': 'æ˜¼é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å§‹ã¾ã‚‹ãƒ‰ã‚­ãƒ‰ã‚­ã€‚ä¼šã†å‰ã‹ã‚‰é«˜ã¾ã‚‹æœŸå¾…æ„Ÿã€‚',
    'ğŸ•µï¸â€â™€ï¸ è¦—ãè¦‹èˆˆå¥®æ´¾': 'ç§˜å¯†ã‚ã„ãŸé›°å›²æ°—ã‚„ã‚¿ãƒ–ãƒ¼æ„ŸãŒã€ã‚ˆã‚Šæ·±ã„èˆˆå¥®ã‚’å‘¼ã³èµ·ã“ã™ã€‚',
    'ğŸ“š å­¦ç¿’ç ”ç©¶æ´¾': 'ã‚ˆã‚Šè‰¯ã„å¿«æ„Ÿã‚’æ±‚ã‚ã¦ã€ãŠäº’ã„ã®ä½“ã‚’ç ”ç©¶ã—å°½ãã™æ¢æ±‚è€…ã€‚',
    'ğŸ§­ ã‚¬ã‚¤ãƒ‰æ´¾': 'ç›¸æ‰‹ã‚’å„ªã—ãå°ãã€ä¸€ç·’ã«é«˜ã¿ã‚’ç›®æŒ‡ã™ä¸å¯§ãªæ™‚é–“ã€‚',
    'ğŸ¤¹â€â™€ï¸ ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯æ´¾': 'è¤‡æ•°ã®åˆºæ¿€ã‚’åŒæ™‚ã«æ“ã‚Šã€å…¨èº«ã§å¿«æ„Ÿã‚’å‘³ã‚ã„å°½ãã™ã€‚',
    'ğŸ’¤ ã¾ã£ãŸã‚Šæ´¾': 'æ™‚é–“ã‚’å¿˜ã‚Œã¦ã‚†ã£ãŸã‚Šã¨ã€‚æ€¥ãŒãšç„¦ã‚‰ãšã€ã˜ã£ãã‚Šæ„›ã‚’è‚²ã‚€ã€‚',
    'ğŸ§· è»½SMè€æ€§ã‚ã‚Š': 'è»½ã„ç¸›ã‚Šã‚„ç›®éš ã—ã€‚æ”¯é…ã¨æœå¾“ã®ã‚²ãƒ¼ãƒ ã§æ–°ã—ã„ä¸–ç•Œã‚’é–‹ãã€‚'
  };
  
  // combinedTagsã«å«ã¾ã‚Œã‚‹ã‚¿ã‚°ã®ææ¡ˆã‚’åé›†
  for (const [tag, text] of Object.entries(tagTexts)) {
    if (combinedTags.has(tag)) {
      recommendations.push({ tag, text });
    }
  }
  
  return recommendations;
};

// ã‚·ãƒ¼ãƒ‰ä»˜ãä¹±æ•°ç”Ÿæˆå™¨
export function seededRandom(seed: number): () => number {
  let x = seed;
  return () => {
    x = (x * 1103515245 + 12345) % 2147483648;
    return x / 2147483648;
  };
}

// é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
export function shuffleArray<T>(array: T[], rng: () => number): T[] {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// ã‚¿ã‚°ææ¡ˆã‚’é¸æŠã—ã¦æ–‡å­—åˆ—ã«ã™ã‚‹
export function selectAndFormatRecommendations(
  recommendations: { tag: string; text: string }[],
  maxCount: number = 5,
  seed: number = 42
): string {
  if (recommendations.length === 0) return '';
  
  const rng = seededRandom(seed);
  let selected: { tag: string; text: string }[] = [];
  
  if (recommendations.length <= maxCount) {
    selected = recommendations;
  } else {
    // maxCountå€‹ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
    selected = shuffleArray(recommendations, rng).slice(0, maxCount);
  }
  
  return '\n\n' + selected.map(r => r.text).join(' ');
}

// è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæƒ…æ™¯è±Šã‹ãªç‰ˆï¼‰
export const supplementaryTexts = [
  'æµ…ã„çœ ã‚Šã®ä¸­ã§ã‚‚ãŠäº’ã„ã‚’æ±‚ã‚ã€æœã¾ã§ç¶šãç”˜ç¾ãªæ™‚é–“ã€‚',
  'æ±—ã°ã‚“ã è‚Œã¨è‚ŒãŒé‡ãªã‚Šã€å¿ƒè‡“ã®é¼“å‹•ãŒã‚·ãƒ³ã‚¯ãƒ­ã™ã‚‹ç¬é–“ã€‚',
  'æ¯å›é•ã†è¡¨æƒ…ã‚’è¦‹ã›ã‚‹ç›¸æ‰‹ã«ã€é£½ãã‚‹ã“ã¨ã®ãªã„æ¢æ±‚å¿ƒãŒèŠ½ç”Ÿãˆã‚‹ã€‚',
  'å„ªã—ã„ã‚­ã‚¹ã‹ã‚‰å§‹ã¾ã‚Šã€æ¿€ã—ã„æŠ±æ“ã¸ã€‚ç·©æ€¥ã®ãƒªã‚ºãƒ ãŒå¿ƒåœ°ã‚ˆã„ã€‚',
  'äºŒäººã ã‘ã®ç§˜å¯†ã®åœ’ã§ã€è¨€è‘‰ã‚’è¶…ãˆãŸäº¤æ„ŸãŒå§‹ã¾ã‚‹ã€‚'
];

// ãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•ã‚’å®‰å®šåŒ–
export function stabilizeRecommendedPlayText(
  baseText: string,
  targetMin: number = 800,
  targetMax: number = 900,
  seed: number = 42
): string {
  const currentLength = baseText.length;
  
  if (currentLength >= targetMin && currentLength <= targetMax) {
    return baseText;
  }
  
  const rng = seededRandom(seed);
  
  if (currentLength < targetMin) {
    // çŸ­ã„å ´åˆã¯è£œè¶³ã‚’è¿½åŠ 
    let result = baseText;
    const shuffled = shuffleArray(supplementaryTexts, rng);
    
    for (const supplement of shuffled) {
      if (result.length >= targetMin) break;
      result += '\n\n' + supplement;
    }
    
    return result;
  }
  
  // é•·ã„å ´åˆã¯æ®µè½ã‚’å‰Šæ¸›
  const paragraphs = baseText.split('\n\n').filter(p => p.trim());
  
  // é‡è¦åº¦ã®ä½ã„æ®µè½ã‹ã‚‰å‰Šé™¤
  while (paragraphs.length > 4 && paragraphs.join('\n\n').length > targetMax) {
    // å¾Œã‚ã‹ã‚‰2ç•ªç›®ã‚’å‰Šé™¤ï¼ˆæœ€å¾Œã¯ç· ã‚ãªã®ã§æ®‹ã™ï¼‰
    if (paragraphs.length > 5) {
      paragraphs.splice(paragraphs.length - 2, 1);
    } else {
      paragraphs.splice(Math.floor(paragraphs.length / 2), 1);
    }
  }
  
  return paragraphs.join('\n\n');
}